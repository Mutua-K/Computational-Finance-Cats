---
title: "Cat_2"
author: "Joy Kendi"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
library(tidyverse)

S0 <- 100
K <- 100
r <- 0.05
sigma <- 0.20
Time_T <- 0.5
tau <- Time_T
set.seed(1)

BS_Call <- function(S0, K, r, sigma, tau) {
  if (sigma <= 0 || tau <= 0) return(pmax(exp(-r * tau) * (S0 - K), 0))
  
  d1 <- (log(S0 / K) + (r + 0.5 * sigma^2) * tau) / (sigma * sqrt(tau))
  d2 <- d1 - sigma * sqrt(tau)
  
  S0 * pnorm(d1) - K * exp(-r * tau) * pnorm(d2)
}

BS_Price <- BS_Call(S0, K, r, sigma, tau)

MC_Call <- function(M, S0, K, r, sigma, tau, antithetic = TRUE) {
  if (antithetic) {
    m2 <- ceiling(M / 2)
    z <- rnorm(m2)
    z <- c(z, -z)[1:M]
  } else {
    z <- rnorm(M)
  }
  ST <- S0 * exp((r - 0.5 * sigma^2) * tau + sigma * sqrt(tau) * z)
  payoff <- exp(-r * tau) * pmax(ST - K, 0)
  c(MC_Price = mean(payoff), SE = sd(payoff) / sqrt(M))
}

M <- 100000
Payout <- MC_Call(M, S0, K, r, sigma, tau, antithetic = TRUE)
CI_Payout <- Payout["MC_Price"] + c(-1, 1) * 1.96 * Payout["SE"]

cat(sprintf(
  "MC: price = %.6f, SE = %.6f, 95%% CI = [%.6f, %.6f]\n",
  Payout["MC_Price"], Payout["SE"], CI_Payout[1], CI_Payout[2]
))
cat(sprintf("Blackâ€“Scholes: price = %.6f\n\n", BS_Price))

Ms <- round(exp(seq(log(500), log(2e5), length.out = 8)))
result <- map_dfr(Ms, function(m) {
  out <- MC_Call(m, S0, K, r, sigma, tau, antithetic = TRUE)
  tibble(
    M = m,
    MC_Price = out["MC_Price"],
    SE = out["SE"],
    CI_Low = MC_Price - 1.96 * SE,
    CI_High = MC_Price + 1.96 * SE
  )
})

ggplot(result, aes(x = M, y = MC_Price)) +
  geom_hline(yintercept = BS_Price, linetype = 2, color = "steelblue") +
  geom_point() +
  geom_errorbar(aes(ymin = CI_Low, ymax = CI_High), width = 0) +
  scale_x_log10() +
  labs(
    title = "Monte Carlo convergence vs M",
    subtitle = sprintf("S0=%g, K=%g, r=%.2f%%, sigma=%.2f%%, T=%.2f (BS=%.4f)",
                       S0, K, 100*r, 100*sigma, tau, BS_Price),
    x = "Number of simulations M (log scale)",
    y = "Price (95% CI)"
  ) +
  theme_minimal()


```

